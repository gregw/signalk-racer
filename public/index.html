<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SignalK Racer Control</title>
    <style>
        .button-set    { background-color: #4CAF50; color: white; }
        .button-move   { background-color: #2196F3; color: white; }
        .button-rotate { background-color: #FF9800; color: white; }
        button {
            padding: 1em 1.5em;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }

        body {
            font-family: sans-serif;
            max-width: 100%;
            margin: 3em auto;
            text-align: center;
        }
        button {
            padding: 1em 1.5em;
            font-size: 1em;
            cursor: pointer;
        }
        input[readonly] {
            background: #eee;
            border: 1px solid #ccc;
            padding: 0.3em;
        }
        #status {
            margin-top: 2em;
            font-size: 1em;
            color: green;
        }
    </style>
</head>
<body>

<h1>Adjust Start Line</h1>
<div style="display: flex; justify-content: center; align-items: center; gap: 3em; flex-wrap: wrap;">

    <!-- Port Control Cross -->
    <div style="display: grid; grid-template-columns: repeat(3, auto); grid-template-rows: repeat(3, auto); gap: 0.5em;">
        <div></div>
        <button class="button-rotate" onclick="adjustLine('port', 'rotate', 1)">+1°</button>
        <div></div>
        <button class="button-move" onclick="adjustLine('port', 'move', 10)">+10m</button>
        <button class="button-set" onclick="setEnd('setStartLinePort')">Set Port</button>
        <button class="button-move" onclick="adjustLine('port', 'move', -10)">-10m</button>
        <div></div>
        <button class="button-rotate" onclick="adjustLine('port', 'rotate', -1)">-1°</button>
        <div></div>
    </div>

    <!-- Center Info -->
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <label>Line Length (m): <input id="lineLength" readonly style="width: 5em; text-align: center;"></label>
        <label>Line Bias (m): <input id="lineBias" readonly style="width: 5em; text-align: center;"></label>
    </div>

    <!-- Starboard Control Cross -->
    <div style="display: grid; grid-template-columns: repeat(3, auto); grid-template-rows: repeat(3, auto); gap: 0.5em;">
        <div></div>
        <button class="button-rotate" onclick="adjustLine('stb', 'rotate', 1)">+1°</button>
        <div></div>
        <button class="button-move" onclick="adjustLine('stb', 'move', 10)">+10m</button>
        <button class="button-set" onclick="setEnd('setStartLineStb')">Set Starboard</button>
        <button class="button-move" onclick="adjustLine('stb', 'move', -10)">-10m</button>
        <div></div>
        <button class="button-rotate" onclick="adjustLine('stb', 'rotate', -1)">-1°</button>
        <div></div>
    </div>

</div>

<div id="status">Connecting...</div>

<script>
    let socket;
    let statusTimer;
    function updateStatus(message) {
        const status = document.getElementById('status');
        status.textContent = message;
        if (statusTimer) clearTimeout(statusTimer);
        statusTimer = setTimeout(() => {
            if (status.textContent === message) {
                status.textContent = '';
            }
        }, 10000);
    }

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socketUrl = protocol + '//' + window.location.host + '/signalk/v1/stream?subscribe=none';
        socket = new WebSocket(socketUrl);

        socket.onopen = () => {
            updateStatus('✅ Connected to Signal K server');
            socket.send(JSON.stringify({
                context: "vessels.self",
                subscribe: [
                    {
                        path: "navigation.racing.*",
                        policy: "instant"
                    }
                ]
            }));
        };

        socket.onerror = (err) => updateStatus('❌ WebSocket error: ' + err.message);
        socket.onclose = () => {
            updateStatus('❌ Disconnected. Retrying in 5s...');
            setTimeout(connectWebSocket, 5000);
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.updates) {
                data.updates.forEach(update => {
                    if (update.values) {
                        update.values.forEach(value => {
                            if (value.path === "navigation.racing.startLineLength") {
                                document.getElementById("lineLength").value = value.value.toFixed(1);
                            } else if (value.path === "navigation.racing.stbLineBias") {
                                document.getElementById("lineBias").value = value.value.toFixed(1);
                            } else if (value.path === "navigation.racing.timeToStart") {
                                timeToStart = value.value;
                                updateTimerDisplay();
                            } else {
                                console.log("Received value: " + value.path + " = " + JSON.stringify(value.value));
                            }
                        });
                    }
                });
            }
        };
    }

    function setEnd(pathSuffix) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            updateStatus('❌ WebSocket not connected.');
            return;
        }
        socket.send(JSON.stringify({
            context: 'vessels.self',
            put: {
                path: 'navigation.racing.' + pathSuffix,
                value: {}
            }
        }));
        updateStatus(`⏳ Sent request to set ${pathSuffix}`);
    }

    function adjustLine(end, action, amount) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            updateStatus('❌ WebSocket not connected.');
            return;
        }
        socket.send(JSON.stringify({
            context: 'vessels.self',
            put: {
                path: 'navigation.racing.adjustStartLine',
                value: { end, action, amount }
            }
        }));
        updateStatus(`⏳ Sent ${action} ${amount} request for ${end}`);
    }

    connectWebSocket();

    let timeToStart = null;

    function formatTimeToMMSS(seconds) {
        const mm = Math.floor(seconds / 60);
        const ss = Math.floor(seconds % 60);
        return `${mm.toString().padStart(2, '0')}:${ss.toString().padStart(2, '0')}`;
    }

    function formatTimeToHHMMSS(date) {
        return date.toTimeString().split(' ')[0];
    }

    function updateTimerDisplay() {
        if (timeToStart !== null) {
            document.getElementById('timeDisplay').textContent = formatTimeToMMSS(timeToStart);
            const futureTime = new Date(Date.now() + timeToStart * 1000);
            const input = document.getElementById('startTimeInput');
            if (input !== document.activeElement) {
                input.value = formatTimeToHHMMSS(futureTime);
            }
        }
    }

    function adjustStartTime(deltaSeconds) {
        if (timeToStart !== null) {
            timeToStart += deltaSeconds;
            sendTimeToStart(timeToStart);
        }
    }

    function handleStartTimeKey(event) {
        if (event.key === 'Enter') {
            const parts = document.getElementById('startTimeInput').value.split(':');
            if (parts.length === 3) {
                const now = new Date();
                const target = new Date();
                target.setHours(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2]), 0);
                if (target < now) target.setTime(target.getTime() + 24 * 60 * 60 * 1000);  // roll over if needed
                const delta = Math.round((target - now) / 1000);
                sendTimeToStart(delta);
            }
        }
    }

    function sendTimeToStart(seconds) {
        timeToStart = seconds;
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            updateStatus('❌ WebSocket not connected.');
            return;
        }
        socket.send(JSON.stringify({
            context: 'vessels.self',
            put: {
                path: 'navigation.racing.setTimeToStart',
                value: seconds
            }
        }));
        updateStatus(`⏳ Sent new timeToStart: ${seconds} sec`);
    }

    function sendTimerCommand(command) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            updateStatus('❌ WebSocket not connected.');
            return;
        }
        socket.send(JSON.stringify({
            context: 'vessels.self',
            put: {
                path: 'navigation.racing.timerCommand',
                value: command
            }
        }));
        updateStatus(`⏳ Sent timer command: ${command}`);
    }

    // Periodic update loop
    setInterval(() => {
        if (timeToStart !== null && timeToStart > 0) {
            timeToStart--;
            updateTimerDisplay();
        }
    }, 1000);

</script>

<!-- Timer Display -->
<div style="margin-top: 2em;">
    <div id="timeDisplay" style="font-size: 3em; font-weight: bold;">00:00</div>
</div>

<!-- Start Time Row -->
<div style="margin-top: 1em; display: flex; justify-content: center; align-items: center; gap: 1em;">
    <button class="button-move" onclick="adjustStartTime(-60)">-1 min</button>
    <label for="startTimeInput">Start at: <input id="startTimeInput" style="font-size: 1.5em; width: 10em; text-align: center;" onkeydown="handleStartTimeKey(event)"></label>
    <button class="button-move" onclick="adjustStartTime(60)">+1 min</button>
</div>

<!-- Timer Control Buttons -->
<div style="margin-top: 1em;">
    <button class="button-set" onclick="sendTimerCommand('start')">Start</button>
    <button class="button-set" onclick="sendTimerCommand('sync')">Sync</button>
    <button class="button-set" onclick="sendTimerCommand('reset')">Reset</button>
</div>

</body>
</html>